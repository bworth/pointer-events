<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="author" content="Ben Worthington" />
<meta name="description" content="Pointer events test." />
<title>Pointer Events</title>

<style>
:root {
	--face-bg-color-1: hsla(180, 100%, 40%, 0.8);
	--face-bg-color-2: hsla( 60, 100%, 40%, 0.8);
	--face-bg-color-3: hsla(  0, 100%, 40%, 0.8);
	--face-bg-color-4: hsla(240, 100%, 40%, 0.8);
	--face-bg-color-5: hsla(300, 100%, 40%, 0.8);
	--face-bg-color-6: hsla(120, 100%, 40%, 0.8);
	--face-color: hsl(0, 0%, 95%);
	--face-text-shadow: 0 1px hsl(0, 0%, 100%), 0 -1px hsla(0, 0%, 0%, 0.1);
	--face-size: 100px;
	--line-height: 1.5;
}

html {
	font-family: sans-serif;
	line-height: var(--line-height);
	-webkit-text-size-adjust: 100%;
	text-size-adjust: none;
}

body {
	margin: 0;
}

main {
	align-content: center;
	align-items: center;
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	min-height: min(100vh, calc(var(--face-size) * 5));
}

noscript {
	flex: 0 0 100%;
	text-align: center;
}

.container {
	contain: content;
	cursor: pointer;
	flex-shrink: 0;
	margin: 1rem;
	perspective: calc(var(--face-size) * 3);
	touch-action: none;
}

.container:focus {
	outline: unset;
}

.container:focus-visible {
	outline: revert;
}

.container[aria-disabled] {
	cursor: unset;
	filter: grayscale(1);
}

.cube {
	cursor: move;
	height: var(--face-size);
	margin: calc(var(--face-size) / 2);
	position: relative;
	transform:
		rotateX(calc(var(--rotateX) * 1deg))
		rotateY(calc(var(--rotateY) * 1deg))
		rotateZ(calc(var(--rotateZ) * 1deg))
		translateZ(calc(var(--translateZ) * 1px));
	transform-origin: 50% 50% calc(var(--face-size) / -2);
	transform-style: preserve-3d;
	width: var(--face-size);
}

.container[aria-disabled] .cube {
	cursor: unset;
}

.face {
	color: var(--face-color);
	font-size: calc(var(--face-size) / 2);
	height: 100%;
	line-height: var(--face-size);
	position: absolute;
	text-align: center;
	text-shadow: var(--face-text-shadow);
	-webkit-user-select: none;
	user-select: none;
	width: 100%;
}

.front {
	background-color: var(--face-bg-color-1);
}

.top {
	background-color: var(--face-bg-color-2);
	transform: rotateX(90deg) translate3d(0, calc(var(--face-size) / -2), calc(var(--face-size) / 2));
}

.right {
	background-color: var(--face-bg-color-3);
	transform: rotateY(90deg) translate3d(calc(var(--face-size) / 2), 0, calc(var(--face-size) / 2));
}

.left {
	background-color: var(--face-bg-color-4);
	transform: rotateY(-90deg) translate3d(calc(var(--face-size) / -2), 0, calc(var(--face-size) / 2));
}

.bottom {
	background-color: var(--face-bg-color-5);
	transform: rotateX(-90deg) translate3d(0, calc(var(--face-size) / 2), calc(var(--face-size) / 2));
}

.back {
	background-color: var(--face-bg-color-6);
	transform: rotateY(180deg) translateZ(var(--face-size));
}

.controls {
	display: flex;
	flex-shrink: 0;
	justify-content: center;
	margin: 1rem;
	min-width: calc(var(--face-size) * 2);
}

.controls fieldset {
	border: 0;
	flex-shrink: 0;
	margin: 0 0 calc(var(--line-height) * 1em);
	padding: 0;
}

.controls legend {
	padding: 0;
	text-align: center;
	width: 100%;
}

.controls ul {
	margin: 1.5rem 0;
	padding: 0 1.5rem;
}

.controls li {
	align-items: center;
	display: flex;
	margin-bottom: 1.5rem;
	white-space: nowrap;
}

.controls label {
	cursor: pointer;
	flex-shrink: 0;
	margin-right: 1em;
}

.controls input {
	cursor: pointer;
	flex-shrink: 0;
	margin-left: 0;
	margin-right: 0;
}

.controls fieldset[disabled] label,
.controls fieldset[disabled] input {
	cursor: unset;
}

.controls output {
	flex-shrink: 0;
	margin-left: 0.5em;
}

.output-value {
	display: inline-block;
	font-variant: tabular-nums;
	min-width: 2em;
	text-align: right;
}

@media screen and (min-width: 720px) {
	:root {
		--face-size: 200px;
	}
}
</style>
</head>

<body>
<main>
	<noscript>
		<p role="alert"><em>Please enable JavaScript.</em></p>
	</noscript>

	<figure class="container" aria-disabled="true" aria-label="Shape scene">
		<div class="cube" role="img" aria-label="Cube for manipulation">
			<div class="face front">1</div>
			<div class="face top">2</div>
			<div class="face right">3</div>
			<div class="face left">4</div>
			<div class="face bottom">5</div>
			<div class="face back">6</div>
		</div>
	</figure>

	<form class="controls">
		<fieldset disabled>
			<legend>Rotation</legend>
			<ul>
				<li>
					<label for="input-x">X axis</label>
					<input id="input-x" type="range" min="-180" max="180" list="input-list" />
					<output id="output-x" for="input-x"><span class="output-value">0</span>°</output>
				</li>
				<li>
					<label for="input-y">Y axis</label>
					<input id="input-y" type="range" min="-180" max="180" list="input-list" />
					<output id="output-y" for="input-y"><span class="output-value">0</span>°</output>
				</li>
			</ul>
		</fieldset>
	</form>
</main>

<datalist id="input-list">
	<option value="-180">-180°</option>
	<option value="-90">-90°</option>
	<option value="0" selected>0°</option>
	<option value="90">90°</option>
	<option value="180">180°</option>
</datalist>

<script>
function clampRotationValue(value) {
	value = Math.round(value % 360);

	if (value < -180) {
		value = value + 360;
	} else if (value > 180) {
		value = value - 360;
	}

	return value;
}

function transformElement(element, rx = 0, ry = 0, rz = 0, tz = 0) {
	element.style.setProperty('--rotateX', rx);
	element.style.setProperty('--rotateY', ry);
	element.style.setProperty('--rotateZ', rz);
	element.style.setProperty('--translateZ', tz);
}

window.addEventListener('DOMContentLoaded', () => {
	const container = document.querySelector('.container');
	const cube = document.querySelector('.cube');
	const inputX = document.querySelector('#input-x');
	const inputY = document.querySelector('#input-y');
	const outputX = document.querySelector('#output-x .output-value');
	const outputY = document.querySelector('#output-y .output-value');
	let rafId = null,
		translateZ = 0,
		valueX = 0,
		valueY = 0,
		valueZ = 0,
		deltaX, deltaY, startX, startY;

	function init() {
		updateView(valueX, valueY);
		container.setAttribute('tabindex', '0');
		container.removeAttribute('aria-disabled');
		document.querySelector('.controls fieldset').disabled = false;
	}

	function pointer1Moved() {
		updateView(clampRotationValue(valueX + deltaY / 2), clampRotationValue(valueY + deltaX / 2));
		rafId = null;
	}

	function pointer2Moved() {
		transformElement(cube, valueX, valueY, clampRotationValue(valueZ + deltaX), translateZ + deltaY);
		rafId = null;
	}

	function updateView(rx, ry) {
		inputX.value = rx;
		inputY.value = ry;
		outputX.textContent = rx;
		outputY.textContent = ry;
		transformElement(cube, rx, ry);
	}

	cube.addEventListener('pointerdown', (event) => {
		event.target.setPointerCapture(event.pointerId);
		startX = event.clientX;
		startY = event.clientY;
	});

	cube.addEventListener('pointermove', (event) => {
		if (event.target.hasPointerCapture(event.pointerId) && !rafId) {
			deltaX = event.clientX - startX;
			deltaY = startY - event.clientY;

			if (event.buttons === 2) {
				rafId = requestAnimationFrame(pointer2Moved);
			} else {
				rafId = requestAnimationFrame(pointer1Moved);
			}
		}
	});

	cube.addEventListener('lostpointercapture', (event) => {
		valueX = inputX.valueAsNumber;
		valueY = inputY.valueAsNumber;

		if (rafId) {
			cancelAnimationFrame(rafId);
			rafId = null;
		}
	});

	container.addEventListener('keydown', (event) => {
		const delta = event.shiftKey ? 10 : 1;

		switch (event.key) {
			case 'ArrowDown':
				valueX = clampRotationValue(valueX - delta);
				updateView(valueX, valueY);
				event.preventDefault();
				break;

			case 'ArrowLeft':
				valueY = clampRotationValue(valueY - delta);
				updateView(valueX, valueY);
				event.preventDefault();
				break;

			case 'ArrowRight':
				valueY = clampRotationValue(valueY + delta);
				updateView(valueX, valueY);
				event.preventDefault();
				break;

			case 'ArrowUp':
				valueX = clampRotationValue(valueX + delta);
				updateView(valueX, valueY);
				event.preventDefault();
				break;
		}
	});

	container.addEventListener('contextmenu', (event) => {
		event.preventDefault();
	});

	// CSS touch-action: none; is unreliable on iOS 13
	container.addEventListener('touchmove', (event) => {
		event.preventDefault();
	});

	inputX.addEventListener('input', (event) => {
		valueX = event.currentTarget.valueAsNumber;
		updateView(valueX, valueY);
	});

	inputY.addEventListener('input', (event) => {
		valueY = event.currentTarget.valueAsNumber;
		updateView(valueX, valueY);
	});

	init();
});
</script>
</body>
</html>
